# 2.2. サービス分割の原則

サービス分割時には以下の問題を考慮する必要があります：
- いつ分割するか？
- どのように分割するか？

## 2.2.1. いつ分割するか

スタートアッププロジェクトの場合、最初の目標はプロジェクトの実現可能性を検証することです。そのため、この段階では迅速な開発が重視され、市場で検証可能な製品を迅速に提供することが求められます。この目的を達成するため、プロジェクトのアーキテクチャは通常シンプルで、多くの場合モノリシックアーキテクチャを採用します。これにより開発コストが低く抑えられ、迅速に結果を出すことができます。もしプロジェクトが市場のニーズに合わないと判明した場合の損失も少なくて済みます。

初期段階で複雑なマイクロサービスアーキテクチャを採用し、多くの人件費と時間をかけてアーキテクチャ設計を行った結果、製品が市場のニーズに合わないと判明した場合、無駄な作業になってしまいます。

そのため、ほとんどの小規模プロジェクトでは、最初にモノリシックアーキテクチャを採用し、ユーザー規模の拡大やビジネスの複雑化に伴って徐々にマイクロサービスアーキテクチャに分割していくことが一般的です。これにより初期コストが低く抑えられ、迅速に試行錯誤が可能です。ただし、この方法の問題点は、後でサービスを分割する際にコードの結合が密であるために分割が難しくなることです（前易後難）。

一方、一部の大規模プロジェクトでは、当初から明確な目的を持って立ち上げられ、長期的な視点でアーキテクチャ設計を行うため、最初からマイクロサービスアーキテクチャを選択します。初期の投資は大きくなりますが、後でサービスを分割する手間が省けます（前難後易）。

## 2.2.2. どのように分割するか

マイクロサービスの分割時には、粒度を小さくすることが目標です。具体的には以下の2つの観点から分析できます：
- **高凝集性**：各マイクロサービスの責任はできるだけ単一にし、関連性の高いビジネスを包括的に含めること。
- **低結合性**：各マイクロサービスの機能は相対的に独立しており、他のマイクロサービスへの依存を最小限に抑えること、または依存するインターフェースの安定性を高めること。

### 高凝集性

高凝集性はまず単一責任を意味しますが、1つのマイクロサービスが1つのインターフェースしか持たないということではありません。マイクロサービス内部のビジネスの完全性を保証することが前提です。目標は、あるビジネスを変更する際に、その変更が現在のマイクロサービスにのみ影響を与えるようにすることで、変更コストを低く抑えることです。

マイクロサービスが高凝集性を実現すると、サービス間の結合度は自然に低下します。

### 低結合性

マイクロサービス間には避けられないビジネス上の相互作用があります。例えば、注文時に商品データを照会する必要がある場合などです。この場合、注文サービスが直接商品データベースを照会してはいけません。そうするとデータの結合が発生してしまいます。代わりに、商品サービスが対応するインターフェースを公開し、マイクロサービスの外部インターフェースの安定性を保証する必要があります（つまり、インターフェースの外観をできるだけ変更しないこと）。これにより、商品サービスの内部でどのような変更を行っても、注文マイクロサービスに影響を与えず、サービス間の結合度が低下します。

### 分割方法

分割の目標を明確にしたら、次は分割方法です。サービス分割時には一般的に以下の2つの方法があります：
- **縦方向の分割**
- **横方向の分割**

#### 縦方向の分割

縦方向の分割は、プロジェクトの機能モジュールに基づいて行います。例えば、あるECサイトでは、ユーザー管理機能、注文管理機能、ショッピングカート機能、商品管理機能、支払い機能などがあります。これらの機能モジュールをそれぞれ独立したサービスに分割することを縦方向の分割と呼びます。この分割方法は、サービスの凝集性を可能な限り高めることができます。

#### 横方向の分割

横方向の分割は、各機能モジュール間に共通のビジネス部分があるかどうかを確認し、ある場合はそれを共通サービスとして抽出します。例えば、ユーザーログイン時にメッセージ通知を送信し、リスク管理データを記録する必要があり、注文時にもSMSを送信し、リスク管理データを記録する必要がある場合、メッセージ送信とリスク管理データの記録は共通のビジネス機能となります。これらをそれぞれ共通サービスとして抽出します：メッセージセンターサービス、リスク管理サービス。これにより、ビジネスの再利用性が向上し、重複開発を防ぐことができます。また、共通ビジネスは一般的にインターフェースの安定性が高く、サービス間の過度な結合も防ぐことができます。
