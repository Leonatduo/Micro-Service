# 2.2. 服务拆分原则

服务拆分时需要考虑以下几个问题：
- 什么时候拆？
- 如何拆？

## 2.2.1. 什么时候拆

对于初创项目，首要任务是验证项目的可行性。因此，这一阶段的重点是敏捷开发，快速产出可用的产品并投入市场进行验证。为了达到这一目的，项目架构通常会比较简单，很多情况下会直接采用单体架构。这样开发成本较低，可以快速产出结果。如果发现项目不符合市场需求，损失也较小。

如果在初期就采用复杂的微服务架构，投入大量的人力和时间成本进行架构设计，最终发现产品不符合市场需求，就等于做了无用功。

因此，对于大多数小型项目，通常会先采用单体架构，随着用户规模扩大和业务复杂度增加，再逐渐拆分为微服务架构。这样初期成本较低，可以快速试错。但这样做的问题是，后期进行服务拆分时，可能会遇到代码耦合带来的问题，拆分会比较困难（前易后难）。

而对于一些大型项目，立项之初目的就很明确，为了长远考虑，在架构设计时就直接选择微服务架构。虽然前期投入较多，但后期就少了拆分服务的烦恼（前难后易）。

## 2.2.2. 怎么拆

微服务拆分时，粒度要小，这是拆分的目标。具体可以从两个角度来分析：
- **高内聚**：每个微服务的职责要尽量单一，包含的业务相互关联度高、完整度高
- **低耦合**：每个微服务的功能要相对独立，尽量减少对其它微服务的依赖，或者依赖接口的稳定性要强

### 高内聚

高内聚首先是单一职责，但不能说一个微服务就一个接口，而是要保证微服务内部业务的完整性为前提。目标是当我们要修改某个业务时，最好只修改当前微服务，这样变更的成本更低

一旦微服务做到了高内聚，那么服务之间的耦合度自然就降低了

### 低耦合

微服务之间不可避免的会有或多或少的业务交互，比如下单时需要查询商品数据。这个时候我们不能在订单服务直接查询商品数据库，否则就导致了数据耦合。而应该由商品服务对应暴露接口，并且一定要保证微服务对外接口的稳定性（即：尽量保证接口外观不变）。虽然出现了服务间调用，但此时无论你如何在商品服务做内部修改，都不会影响到订单微服务，服务间的耦合度就降低了。

### 拆分方式

明确了拆分目标后，接下来就是拆分方式了。我们在做服务拆分时一般有两种方式：
- **纵向拆分**
- **横向拆分**

#### 纵向拆分

纵向拆分是按照项目的功能模块来拆分。例如，黑马商城中，有用户管理功能、订单管理功能、购物车功能、商品管理功能、支付功能等。按照功能模块将它们拆分为一个个服务，就属于纵向拆分。这种拆分模式可以尽可能提高服务的内聚性。

#### 横向拆分

横向拆分是看各个功能模块之间有没有公共的业务部分，如果有，将其抽取出来作为通用服务。例如，用户登录时需要发送消息通知，记录风控数据，下单时也要发送短信，记录风控数据。因此，消息发送、风控数据记录就是通用的业务功能，可以将它们分别抽取为公共服务：消息中心服务、风控管理服务。这样可以提高业务的复用性，避免重复开发。同时，通用业务一般接口稳定性较强，也不会使服务之间过分耦合。
