# 3.1 レジストリの原理

前章では、マイクロサービスの分割を実現し、HTTPリクエストを通じてマイクロサービス間のリモート呼び出しを実装しました。しかし、手動でHTTPリクエストを送信する方法にはいくつかの問題があります：

- マイクロサービスのマルチインスタンスデプロイ時、各インスタンスのIPやポートが異なる場合、これらのインスタンスのアドレスをどのように管理するか？
- HTTPリクエストにはURLアドレスを指定する必要がありますが、呼び出し側は具体的なマイクロサービスインスタンスをどのように選択するか？
- あるマイクロサービスインスタンスがダウンした場合、呼び出し側がそれにアクセスしようとするのをどのように処理するか？

これらの問題を解決するために、**レジストリ**の概念を導入する必要があります。

---

## レジストリの役割

マイクロサービスのリモート呼び出しプロセスにおいて、2つの主要な役割があります：

1. **サービスプロバイダー**：他のマイクロサービスがアクセスするためのインターフェースを提供します。
2. **サービスコンシューマー**：他のマイクロサービスが提供するインターフェースを呼び出します。

大規模なマイクロサービスプロジェクトでは、サービスプロバイダーの数が非常に多いため、これらのサービスを効果的に管理するためにレジストリが生まれました。

---

## レジストリのワークフロー

1. **サービス登録**：
   - サービスが起動すると、自身のサービス情報（サービス名、IP、ポート）をレジストリに登録します。

2. **サービスサブスクリプション**：
   - 呼び出し側はレジストリから必要なサービスをサブスクライブし、サービスのインスタンスリストを取得します（1つのサービスが複数のインスタンスでデプロイされている場合があります）。

3. **ロードバランシング**：
   - 呼び出し側はロードバランシング戦略に基づいて、インスタンスリストから1つのインスタンスを選択します。

4. **リモート呼び出し**：
   - 呼び出し側は選択したインスタンスに対してリモート呼び出しを行います。

---

## サービスインスタンスの動的管理

サービスプロバイダーのインスタンスに変更が発生した場合（例：ダウンまたは新規インスタンスの追加）、レジストリはサービスリストを動的に更新します：

1. **ハートビートメカニズム**：
   - サービスプロバイダーは定期的にレジストリにハートビートリクエストを送信し、自身の健康状態を報告します。
   - レジストリが長時間ハートビートを受信しない場合、そのインスタンスはダウンしたと判断し、サービスインスタンスリストから削除します。

2. **新規インスタンス登録**：
   - 新規インスタンスが起動すると、レジストリに登録リクエストを送信し、レジストリはその情報をサービスインスタンスリストに追加します。

3. **サービスリスト更新**：
   - レジストリのサービスリストに変更が発生した場合、マイクロサービスに通知し、ローカルのサービスリストを更新します。

---

## まとめ

レジストリの主な役割は以下の通りです：
- **サービスの登録と発見**：サービスインスタンスの登録と発見を管理します。
- **動的更新**：ハートビートメカニズムと通知メカニズムを通じて、サービスリストのリアルタイム性と正確性を確保します。
- **ロードバランシング**：呼び出し側に複数のインスタンス選択を提供し、ロードバランシング戦略をサポートします。

レジストリを導入することで、マイクロサービスアーキテクチャはマルチインスタンスデプロイ、動的拡張、および障害回復などのシナリオにより適切に対応できるようになります。
